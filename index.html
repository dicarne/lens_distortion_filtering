<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>Radial lens undistortion filter</title>
  <script type="text/javascript" src="utils/glMatrix-0.9.5.min.js"></script>
  <script type="text/javascript" src="utils/webgl-utils.js"></script>
  <script type="text/javascript" src="utils/webgl-debug.js"></script>

  <script id="shader-fs" type="x-shader/x-fragment">
    precision mediump float;
    
    uniform sampler2D texture_diffuse;
    uniform vec2 image_dimensions;
    uniform float alphax;
    uniform float alphay;
    
    varying vec4 pass_Color;
    varying vec2 pass_TextureCoord;

    void main(void) {
    
      // Normalize the u,v coordinates in the range [-1;+1]
      float x = (2.0 * pass_TextureCoord.x - 1.0) / 1.0;
      float y = (2.0 * pass_TextureCoord.y - 1.0) / 1.0;
      
      // Calculate l2 norm
      float r = x*x + y*y;
      
      // Calculate the deflated or inflated new coordinate (reverse transform)
      float x3 = x / (1.0 - alphax * r);
		  float y3 = y / (1.0 - alphay * r); 
			float x2 = x / (1.0 - alphax * (x3 * x3 + y3 * y3));
			float y2 = y / (1.0 - alphay * (x3 * x3 + y3 * y3));	
      
      // Forward transform
      // float x2 = x * (1.0 - alphax * r);
      // float y2 = y * (1.0 - alphay * r);

      // De-normalize to the original range
      float i2 = (x2 + 1.0) * 1.0 / 2.0;
      float j2 = (y2 + 1.0) * 1.0 / 2.0;
    
      if(i2 >= 0.0 && i2 <= 1.0 && j2 >= 0.0 && j2 <= 1.0)
        gl_FragColor = texture2D(texture_diffuse, vec2(i2, j2));
      else
        gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
    }
  </script>

  <script id="shader-vs" type="x-shader/x-vertex">
    attribute vec4 in_Position;
    attribute vec4 in_Color;
    attribute vec2 in_TextureCoord;    
    
    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
    
    varying vec4 pass_Color;
    varying vec2 pass_TextureCoord;
    
    void main(void) {
      gl_Position = uPMatrix * uMVMatrix * in_Position;
      
      pass_Color = in_Color;
      pass_TextureCoord = in_TextureCoord;
    }
  </script>

  <script type="text/javascript">
    var gl; // gl instance
    // add by dicarne
    var gl2;
    var glt;
    var gl3
    function webGLStart() {

      var canvas = document.getElementById("filter-canvas");
      try {
        gl = canvas.getContext("experimental-webgl");
        gl.viewportWidth = canvas.width;
        gl.viewportHeight = canvas.height;
        gl.rendercount = 1;
      } catch (e) { }
      if (!gl) {
        alert("Could not initialize WebGL");
      }
      var canvas2 = document.getElementById("filter2-canvas");
      try {
        gl2 = canvas2.getContext("experimental-webgl");
        gl2.viewportWidth = canvas2.width;
        gl2.viewportHeight = canvas2.height;
        gl2.rendercount = 2;
      } catch (e) { }
      if (!gl2) {
        alert("Could not initialize WebGL");
      }
      var canvas3 = document.getElementById("filter0-canvas");
      try {
        glt = canvas3.getContext("experimental-webgl");
        glt.viewportWidth = canvas3.width;
        glt.viewportHeight = canvas3.height;
        glt.rendercount = 3;
      } catch (e) { }
      if (!glt) {
        alert("Could not initialize WebGL");
      }
      var canvas4 = document.getElementById("filter3-canvas");
      try {
        gl3 = canvas4.getContext("experimental-webgl");
        gl3.viewportWidth = canvas4.width;
        gl3.viewportHeight = canvas4.height;
        gl3.rendercount = 4;
      } catch (e) { }
      if (!glt) {
        alert("Could not initialize WebGL");
      }
      gl.mvMatrix = mat4.create(); // Warning: does not default to identity
      gl.pMatrix = mat4.create();  // Warning: does not default to identity    
      gl2.mvMatrix = mat4.create(); // Warning: does not default to identity
      gl2.pMatrix = mat4.create();  // Warning: does not default to identity 
      glt.mvMatrix = mat4.create(); // Warning: does not default to identity
      glt.pMatrix = mat4.create();  // Warning: does not default to identity 
      gl3.mvMatrix = mat4.create(); // Warning: does not default to identity
      gl3.pMatrix = mat4.create();  // Warning: does not default to identity 
      webGLStart_inside(gl);
      webGLStart_inside(gl2);
      webGLStart_inside(glt);
      webGLStart_inside(gl3);
      paintLoop();
    }

    function webGLStart_inside(igl) {
      setupQuad(igl);
      initShaders(igl);
      initTexture(igl);

      ctx = WebGLDebugUtils.makeDebugContext(igl.clearColor(0.0, 0.0, 0.0, 1.0));
      ctx = WebGLDebugUtils.makeDebugContext(igl.enable(igl.DEPTH_TEST));


    }
    // end add
    var fboid;

    var alphax = 0.0;
    var alphax2 = 0.0;
    var alphay = 0.0;
    var alphay2 = 0.0;
    var maximum_alpha = 0.25;
    //var shaderProgram;
    var textureIsSafeToRender = false;


    function getShader(gl, id) {
      var shaderScript = document.getElementById(id);
      if (!shaderScript)
        return null;

      var str = "";
      var k = shaderScript.firstChild;
      while (k) {
        if (k.nodeType == 3) { // Check for TEXT_NODE
          str += k.textContent;
        }
        k = k.nextSibling;
      }

      var shader;
      if (shaderScript.type == "x-shader/x-fragment") {
        ctx = WebGLDebugUtils.makeDebugContext(shader = gl.createShader(gl.FRAGMENT_SHADER));
      } else if (shaderScript.type == "x-shader/x-vertex") {
        ctx = WebGLDebugUtils.makeDebugContext(shader = gl.createShader(gl.VERTEX_SHADER));
      } else {
        return null;
      }

      ctx = WebGLDebugUtils.makeDebugContext(gl.shaderSource(shader, str));
      ctx = WebGLDebugUtils.makeDebugContext(gl.compileShader(shader));

      if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
        alert(gl.getShaderInfoLog(shader));
        return null;
      }

      return shader;
    }

    function initShaders(igl) {

      var fragmentShader = getShader(igl, "shader-fs");
      var vertexShader = getShader(igl, "shader-vs");

      ctx = WebGLDebugUtils.makeDebugContext(igl.shaderProgram = igl.createProgram());
      ctx = WebGLDebugUtils.makeDebugContext(igl.attachShader(igl.shaderProgram, vertexShader));
      ctx = WebGLDebugUtils.makeDebugContext(igl.attachShader(igl.shaderProgram, fragmentShader));
      ctx = WebGLDebugUtils.makeDebugContext(igl.linkProgram(igl.shaderProgram));

      if (!igl.getProgramParameter(igl.shaderProgram, igl.LINK_STATUS)) {
        alert("Could not initialize shaders");
      }

      ctx = WebGLDebugUtils.makeDebugContext(igl.useProgram(igl.shaderProgram));

      // Enable vertex attribute arrays for position, color, uvs

      ctx = WebGLDebugUtils.makeDebugContext(igl.shaderProgram.inPosition = igl.getAttribLocation(igl.shaderProgram, "in_Position"));
      ctx = WebGLDebugUtils.makeDebugContext(igl.enableVertexAttribArray(igl.shaderProgram.inPosition));

      igl.shaderProgram.inColor = igl.getAttribLocation(igl.shaderProgram, "in_Color");
      ctx = WebGLDebugUtils.makeDebugContext(igl.enableVertexAttribArray(igl.shaderProgram.inColor));

      igl.shaderProgram.inTextureCoord = igl.getAttribLocation(igl.shaderProgram, "in_TextureCoord");
      ctx = WebGLDebugUtils.makeDebugContext(igl.enableVertexAttribArray(igl.shaderProgram.inTextureCoord));

      // Bind uniforms for matrices
      ctx = WebGLDebugUtils.makeDebugContext(igl.shaderProgram.pMatrixUniform = igl.getUniformLocation(igl.shaderProgram, "uPMatrix"));
      ctx = WebGLDebugUtils.makeDebugContext(igl.shaderProgram.mvMatrixUniform = igl.getUniformLocation(igl.shaderProgram, "uMVMatrix"));

      // Bind uniform for image dimensions and alpha factors
      ctx = WebGLDebugUtils.makeDebugContext(igl.shaderProgram.imageDimensionsUniform = igl.getUniformLocation(igl.shaderProgram, "image_dimensions"));
      ctx = WebGLDebugUtils.makeDebugContext(igl.shaderProgram.alphax = igl.getUniformLocation(igl.shaderProgram, "alphax"));
      ctx = WebGLDebugUtils.makeDebugContext(igl.shaderProgram.alphay = igl.getUniformLocation(igl.shaderProgram, "alphay"));


    }

    function setupQuad(igl) {
      // Set up VBO with quad data
      ctx = WebGLDebugUtils.makeDebugContext(igl.vboId = igl.createBuffer());
      ctx = WebGLDebugUtils.makeDebugContext(igl.bindBuffer(igl.ARRAY_BUFFER, igl.vboId));
      var vbo_data = [
        -0.5, 0.5, 0.0, 1.0,    // Vertex (xyzw)
        1.0, 0.0, 0.0, 1.0,     // RGBA
        0.0, 1.0,               // UV coords

        -0.5, -0.5, 0.0, 1.0,   // Vertex (xyzw)
        0.0, 1.0, 0.0, 1.0,     // RGBA
        0.0, 0.0,               // UV coords

        0.5, -0.5, 0.0, 1.0,    // Vertex (xyzw)
        0.0, 0.0, 1.0, 1.0,     // RGBA
        1.0, 0.0,               // UV coords

        0.5, 0.5, 0.0, 1.0,     // Vertex (xyzw)
        1.0, 1.0, 1.0, 1.0,     // RGBA
        1.0, 1.0                // UV coords
      ];
      ctx = WebGLDebugUtils.makeDebugContext(igl.bufferData(igl.ARRAY_BUFFER, new Float32Array(vbo_data), igl.STATIC_DRAW));
      // Set up VBO with indices data
      ctx = WebGLDebugUtils.makeDebugContext(igl.vboiId = igl.createBuffer());
      ctx = WebGLDebugUtils.makeDebugContext(igl.bindBuffer(igl.ELEMENT_ARRAY_BUFFER, igl.vboiId));
      var indices = [
        0, 1, 2,
        2, 3, 0
      ];
      ctx = WebGLDebugUtils.makeDebugContext(igl.bufferData(igl.ELEMENT_ARRAY_BUFFER, new Uint16Array(indices), igl.STATIC_DRAW));
      igl.indices_count = indices.length;
    }

    function initTexture(igl) {
      igl.textures = [];
      igl.rb = [];
      igl.FBOs = [];
      ctx = WebGLDebugUtils.makeDebugContext(igl.textureId = igl.createTexture());
      igl.textureId.image = new Image();
      igl.textureId.image.src = "assets/dis.png";
      igl.textureId.image.onload = function () {
        ctx = WebGLDebugUtils.makeDebugContext(igl.bindTexture(igl.TEXTURE_2D, igl.textureId));
        ctx = WebGLDebugUtils.makeDebugContext(igl.pixelStorei(igl.UNPACK_FLIP_Y_WEBGL, true));
        ctx = WebGLDebugUtils.makeDebugContext(igl.texImage2D(igl.TEXTURE_2D, 0, igl.RGBA, igl.RGBA, igl.UNSIGNED_BYTE, igl.textureId.image));
        ctx = WebGLDebugUtils.makeDebugContext(igl.texParameteri(igl.TEXTURE_2D, igl.TEXTURE_MAG_FILTER, igl.LINEAR));
        ctx = WebGLDebugUtils.makeDebugContext(igl.texParameteri(igl.TEXTURE_2D, igl.TEXTURE_MIN_FILTER, igl.LINEAR));
        ctx = WebGLDebugUtils.makeDebugContext(igl.bindTexture(igl.TEXTURE_2D, null));
        //for (var i = 0; i < igl.rendercount; i++) {
        for (var i = 0; i < 2; i++) {
          ctx = WebGLDebugUtils.makeDebugContext(igl.activeTexture(igl.TEXTURE0));
          var texture = igl.createTexture();
          ctx = WebGLDebugUtils.makeDebugContext(igl.bindTexture(igl.TEXTURE_2D, texture));
          //

          ctx = WebGLDebugUtils.makeDebugContext(igl.texImage2D(igl.TEXTURE_2D, 0, igl.RGBA, igl.RGBA, igl.UNSIGNED_BYTE, igl.textureId.image));
          ctx = WebGLDebugUtils.makeDebugContext(igl.texParameteri(igl.TEXTURE_2D, igl.TEXTURE_WRAP_S, igl.CLAMP_TO_EDGE));
          ctx = WebGLDebugUtils.makeDebugContext(igl.texParameteri(igl.TEXTURE_2D, igl.TEXTURE_WRAP_T, igl.CLAMP_TO_EDGE));
          ctx = WebGLDebugUtils.makeDebugContext(igl.texParameteri(igl.TEXTURE_2D, igl.TEXTURE_MIN_FILTER, igl.LINEAR));
          ctx = WebGLDebugUtils.makeDebugContext(igl.texParameteri(igl.TEXTURE_2D, igl.TEXTURE_MAG_FILTER, igl.LINEAR));

          var fb = igl.createFramebuffer();
          igl.bindFramebuffer(igl.FRAMEBUFFER, fb);
          igl.framebufferTexture2D(igl.FRAMEBUFFER, igl.COLOR_ATTACHMENT0, igl.TEXTURE_2D, texture, 0);

          var trb = igl.createRenderbuffer();
          ctx = WebGLDebugUtils.makeDebugContext(igl.bindRenderbuffer(igl.RENDERBUFFER, trb));
          ctx = WebGLDebugUtils.makeDebugContext(igl.renderbufferStorage(igl.RENDERBUFFER, igl.DEPTH_COMPONENT16, 512, 512));
          ctx = WebGLDebugUtils.makeDebugContext(igl.framebufferRenderbuffer(igl.FRAMEBUFFER, igl.DEPTH_ATTACHMENT, igl.RENDERBUFFER, trb));
          ctx = WebGLDebugUtils.makeDebugContext(igl.bindRenderbuffer(igl.RENDERBUFFER, null));

          igl.rb.push(trb);
          igl.textures.push(texture);
          igl.FBOs.push(fb);
          ctx = WebGLDebugUtils.makeDebugContext(igl.bindTexture(igl.TEXTURE_2D, null));
        }
        textureIsSafeToRender = true;
      }

      igl.imageDimensions = new Float32Array([igl.textureId.image.width, igl.textureId.image.height]);


      /*}*/

    }

    function drawScene(gl) {
      ctx = WebGLDebugUtils.makeDebugContext(gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight));

      if (textureIsSafeToRender == false) {
        console.log("Still can't render stuff if the texture hasn't been loaded yet");
        return; // Still can't render stuff if the texture hasn't been loaded yet
      }
      // Set matrix uniforms
      mat4.perspective(45, gl.viewportWidth / gl.viewportHeight, 0.1, 100.0, gl.pMatrix);
      mat4.identity(gl.mvMatrix);
      mat4.translate(gl.mvMatrix, [0.0, 0.0, -1.2]);
      ctx = WebGLDebugUtils.makeDebugContext(gl.uniformMatrix4fv(gl.shaderProgram.pMatrixUniform, false, gl.pMatrix));
      ctx = WebGLDebugUtils.makeDebugContext(gl.uniformMatrix4fv(gl.shaderProgram.mvMatrixUniform, false, gl.mvMatrix));

      // Set image dimensions uniform
      ctx = WebGLDebugUtils.makeDebugContext(gl.uniform2fv(gl.shaderProgram.imageDimensionsUniform, gl.imageDimensions));
      ctx = WebGLDebugUtils.makeDebugContext(gl.bindTexture(gl.TEXTURE_2D, gl.textureId));
      ctx = WebGLDebugUtils.makeDebugContext(gl.activeTexture(gl.TEXTURE0));
      var sampler2D_loc = gl.getUniformLocation(gl.shaderProgram, "texture_diffuse");

      ctx = WebGLDebugUtils.makeDebugContext(gl.uniform1i(sampler2D_loc, 0));

      // Bind vertex data and set vertex attributes (as from a VAO)
      ctx = WebGLDebugUtils.makeDebugContext(gl.bindBuffer(gl.ARRAY_BUFFER, gl.vboId));

      if (gl.rendercount <= 2) {
        ctx = WebGLDebugUtils.makeDebugContext(gl.uniform1fv(gl.shaderProgram.alphax, new Float32Array([alphax])));
        ctx = WebGLDebugUtils.makeDebugContext(gl.uniform1fv(gl.shaderProgram.alphay, new Float32Array([alphay])));
        ctx = WebGLDebugUtils.makeDebugContext(gl.bindFramebuffer(gl.FRAMEBUFFER, gl.FBOs[0]));
        ctx = WebGLDebugUtils.makeDebugContext(gl.vertexAttribPointer(gl.shaderProgram.inPosition, 4, gl.FLOAT, false, 10 * 4, 0));
        ctx = WebGLDebugUtils.makeDebugContext(gl.vertexAttribPointer(gl.shaderProgram.inColor, 4, gl.FLOAT, false, 10 * 4, 4 * 4));
        //ctx = WebGLDebugUtils.makeDebugContext(gl.vertexAttribPointer(gl.shaderProgram.inTextureCoord, 2, gl.FLOAT, false, 10 * 4, 8 * 4));
        ctx = WebGLDebugUtils.makeDebugContext(gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, gl.vboiId));
        ctx = WebGLDebugUtils.makeDebugContext(gl.vertexAttribPointer(gl.shaderProgram.inTextureCoord, 2, gl.FLOAT, false, 10 * 4, 8 * 4));

        ctx = WebGLDebugUtils.makeDebugContext(gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT));
        ctx = WebGLDebugUtils.makeDebugContext(gl.drawElements(gl.TRIANGLES, gl.indices_count, gl.UNSIGNED_SHORT, 0));
        ctx = WebGLDebugUtils.makeDebugContext(gl.bindTexture(gl.TEXTURE_2D, gl.textures[0]));

      } else {
        ctx = WebGLDebugUtils.makeDebugContext(gl.uniform1fv(gl.shaderProgram.alphax, new Float32Array([0])));
        ctx = WebGLDebugUtils.makeDebugContext(gl.uniform1fv(gl.shaderProgram.alphay, new Float32Array([0])));
        ctx = WebGLDebugUtils.makeDebugContext(gl.bindFramebuffer(gl.FRAMEBUFFER, gl.FBOs[0]));
        ctx = WebGLDebugUtils.makeDebugContext(gl.vertexAttribPointer(gl.shaderProgram.inPosition, 4, gl.FLOAT, false, 10 * 4, 0));
        ctx = WebGLDebugUtils.makeDebugContext(gl.vertexAttribPointer(gl.shaderProgram.inColor, 4, gl.FLOAT, false, 10 * 4, 4 * 4));
        //ctx = WebGLDebugUtils.makeDebugContext(gl.vertexAttribPointer(gl.shaderProgram.inTextureCoord, 2, gl.FLOAT, false, 10 * 4, 8 * 4));
        ctx = WebGLDebugUtils.makeDebugContext(gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, gl.vboiId));
        ctx = WebGLDebugUtils.makeDebugContext(gl.vertexAttribPointer(gl.shaderProgram.inTextureCoord, 2, gl.FLOAT, false, 10 * 4, 8 * 4));

        ctx = WebGLDebugUtils.makeDebugContext(gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT));
        ctx = WebGLDebugUtils.makeDebugContext(gl.drawElements(gl.TRIANGLES, gl.indices_count, gl.UNSIGNED_SHORT, 0));
        ctx = WebGLDebugUtils.makeDebugContext(gl.bindTexture(gl.TEXTURE_2D, gl.textures[0]));
      }

      /*---------------------------------------------------------------*/
      if (gl.rendercount == 2 || gl.rendercount == 3) {
        ctx = WebGLDebugUtils.makeDebugContext(gl.uniform1fv(gl.shaderProgram.alphax, new Float32Array([alphax2])));
        ctx = WebGLDebugUtils.makeDebugContext(gl.uniform1fv(gl.shaderProgram.alphay, new Float32Array([alphay2])));
        ctx = WebGLDebugUtils.makeDebugContext(gl.bindFramebuffer(gl.FRAMEBUFFER, gl.FBOs[1]));
        ctx = WebGLDebugUtils.makeDebugContext(gl.vertexAttribPointer(gl.shaderProgram.inPosition, 4, gl.FLOAT, false, 10 * 4, 0));
        ctx = WebGLDebugUtils.makeDebugContext(gl.vertexAttribPointer(gl.shaderProgram.inColor, 4, gl.FLOAT, false, 10 * 4, 4 * 4));

        ctx = WebGLDebugUtils.makeDebugContext(gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, gl.vboiId));
        ctx = WebGLDebugUtils.makeDebugContext(gl.vertexAttribPointer(gl.shaderProgram.inTextureCoord, 2, gl.FLOAT, false, 10 * 4, 8 * 4));

        ctx = WebGLDebugUtils.makeDebugContext(gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT));
        ctx = WebGLDebugUtils.makeDebugContext(gl.drawElements(gl.TRIANGLES, gl.indices_count, gl.UNSIGNED_SHORT, 0));
        ctx = WebGLDebugUtils.makeDebugContext(gl.bindTexture(gl.TEXTURE_2D, gl.textures[1]));
      } else if (gl.rendercount == 1 || gl.rendercount == 3) {
        ctx = WebGLDebugUtils.makeDebugContext(gl.uniform1fv(gl.shaderProgram.alphax, new Float32Array([0])));
        ctx = WebGLDebugUtils.makeDebugContext(gl.uniform1fv(gl.shaderProgram.alphay, new Float32Array([0])));
        ctx = WebGLDebugUtils.makeDebugContext(gl.bindFramebuffer(gl.FRAMEBUFFER, gl.FBOs[1]));
        ctx = WebGLDebugUtils.makeDebugContext(gl.vertexAttribPointer(gl.shaderProgram.inPosition, 4, gl.FLOAT, false, 10 * 4, 0));
        ctx = WebGLDebugUtils.makeDebugContext(gl.vertexAttribPointer(gl.shaderProgram.inColor, 4, gl.FLOAT, false, 10 * 4, 4 * 4));

        ctx = WebGLDebugUtils.makeDebugContext(gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, gl.vboiId));
        ctx = WebGLDebugUtils.makeDebugContext(gl.vertexAttribPointer(gl.shaderProgram.inTextureCoord, 2, gl.FLOAT, false, 10 * 4, 8 * 4));

        ctx = WebGLDebugUtils.makeDebugContext(gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT));
        ctx = WebGLDebugUtils.makeDebugContext(gl.drawElements(gl.TRIANGLES, gl.indices_count, gl.UNSIGNED_SHORT, 0));
        ctx = WebGLDebugUtils.makeDebugContext(gl.bindTexture(gl.TEXTURE_2D, gl.textures[1]));
      }
      gl.pixels = new Uint8Array(gl.textureId.image.width * gl.textureId.image.height * 4);
      gl.readPixels(0, 0, gl.drawingBufferWidth, gl.drawingBufferHeight, gl.RGBA, gl.UNSIGNED_BYTE, gl.pixels);

      ctx = WebGLDebugUtils.makeDebugContext(gl.bindFramebuffer(gl.FRAMEBUFFER, null));

      ctx = WebGLDebugUtils.makeDebugContext(gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT));
      ctx = WebGLDebugUtils.makeDebugContext(gl.drawElements(gl.TRIANGLES, gl.indices_count, gl.UNSIGNED_SHORT, 0));

      ctx = WebGLDebugUtils.makeDebugContext(gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, null));
      ctx = WebGLDebugUtils.makeDebugContext(gl.bindBuffer(gl.ARRAY_BUFFER, null));
      ctx = WebGLDebugUtils.makeDebugContext(gl.bindTexture(gl.TEXTURE_2D, null));
      /*}*/

    }

    function paintLoop() {
      requestAnimFrame(paintLoop);
      drawScene(gl);
      drawScene(gl2);
      drawScene(glt);
      drawScene(gl3);
      BNB();
    }

    function BNB() {
      if (gl2.pixels.length <= 1) return;
      var s1 = [];
      var s2 = [];
      var checkarea = 100;

      for (var i = 0; i < 512; i++) {
        if (i >= checkarea && i < 512 - checkarea) {
          var centerheigh = Math.abs(256 - i);
          var leftside = Math.sqrt(checkarea * checkarea - centerheigh * centerheigh);
          var t = gl2.pixels.slice(512 * 4 * i + leftside * 4, 512 * 4 * i + (512 - leftside) * 4);
          for (var j = 0; j < t.length - 1; j += 4) {
            s1.push((t[j] * 299 + t[j + 1] * 587 + t[j + 2] * 114 + 500));
          }
          var t2 = glt.pixels.slice(512 * 4 * i + leftside * 4, 512 * 4 * i + (512 - leftside) * 4);
          for (var j = 0; j < t2.length - 1; j += 4) {
            s2.push((t2[j] * 299 + t2[j + 1] * 587 + t2[j + 2] * 114 + 500));
          }
        }

      }
      console.log(s1);

      var res = s1.map(function (a, b, c) {
        return Math.abs(a - s2[b]);
      });
      var sumnum = res.reduce(function (total, num) {
        return total + num;
      });
      document.getElementById("resultsum").innerHTML = sumnum;
    }


    // ~-~-~-~-~-~-~-~-~- UI related handling routines ~-~-~-~-~-~-~-~-~-

    var same_alpha_factors = true; // Whether alphax and alphay are forced to be equal
    //var same_alpha_factors2 = true;
    function adjustAlphaFactor(direction, value) { // value should be in range [0;100]
      switch (direction) {
        case 'x': {
          alphax = (value * 0.01) * maximum_alpha;
          document.getElementById("alphax_value").value = alphax;
          if (same_alpha_factors) {
            alphay = alphax;
            document.getElementById("alphay_slider").value = value;
            document.getElementById("alphay_value").value = alphay;
          }
        } break;
        case 'y': {
          alphay = (value * 0.01) * maximum_alpha;
          document.getElementById("alphay_value").value = alphay;
          if (same_alpha_factors) {
            alphax = alphay;
            document.getElementById("alphax_slider").value = value;
            document.getElementById("alphax_value").value = alphax;
          }
        } break;
        case 'x2': {
          alphax2 = (value * 0.01) * maximum_alpha;
          document.getElementById("alphax_value2").value = alphax2;
          if (same_alpha_factors) {
            alphay2 = alphax2;
            document.getElementById("alphay_slider2").value = value;
            document.getElementById("alphay_value2").value = alphay2;
          }
        } break;
        case 'y2': {
          alphay2 = (value * 0.01) * maximum_alpha;
          document.getElementById("alphay_value2").value = alphay2;
          if (same_alpha_factors) {
            alphax2 = alphay2;
            document.getElementById("alphax_slider2").value = value;
            document.getElementById("alphax_value2").value = alphax2;
          }
        } break;
      }
    }
    // ~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-

  </script>
</head>

<body onload="webGLStart();">
  <div style="padding: 10px;">
    <div style="float: left;">

      <canvas id="filter-canvas" style="border: none;" width="512" height="512"></canvas>
      <canvas id="filter2-canvas" style="border: none;" width="512" height="512"></canvas>
    </div>
    <div style="float: left; padding: 10px;">
      <input type="checkbox" onchange="same_alpha_factors = this.checked;" checked/>Force square pixels
      <br/>
      <br/>用于畸变的畸变参数
      <br/>
      <br/> Adjust horizontal distortion parameter
      <br/>
      <input id="alphax_slider" type="range" style="vertical-align:middle;" min="-100" max="100" value="0" onchange="adjustAlphaFactor('x', this.value)"
        oninput="adjustAlphaFactor('x', this.value)" />
      <input type="text" id="alphax_value" style="vertical-align:middle; width: 50px; text-align: center;" value="0.0" readonly>
      <br/> Adjust vertical distortion parameter
      <br/>
      <input id="alphay_slider" type="range" style="vertical-align:middle;" min="-100" max="100" value="0" onchange="adjustAlphaFactor('y', this.value)"
        oninput="adjustAlphaFactor('y', this.value)" />
      <input type="text" id="alphay_value" style="vertical-align:middle; width: 50px; text-align: center;" value="0.0" readonly>
      <br/> 用于反畸变的畸变参数
      <br/>
      <br/> Adjust horizontal distortion parameter
      <br/>
      <input id="alphax_slider2" type="range" style="vertical-align:middle;" min="-100" max="100" value="0" onchange="adjustAlphaFactor('x2', this.value)"
        oninput="adjustAlphaFactor('x2', this.value)" />
      <input type="text" id="alphax_value2" style="vertical-align:middle; width: 50px; text-align: center;" value="0.0" readonly>
      <br/> Adjust vertical distortion parameter
      <br/>
      <input id="alphay_slider2" type="range" style="vertical-align:middle;" min="-100" max="100" value="0" onchange="adjustAlphaFactor('y2', this.value)"
        oninput="adjustAlphaFactor('y2', this.value)" />
      <input type="text" id="alphay_value2" style="vertical-align:middle; width: 50px; text-align: center;" value="0.0" readonly>
      <br/>
      <br/>偏差值
      <span id="resultsum"></span>
      <br/>

      <div style="float:right;">
        <br/>原图反畸变后
        <br/>
        <canvas style="float:left;" id="filter0-canvas" style="border: none;" width="512" height="512"></canvas>
      </div>
      <div style="float:right;">
          <br/>原图
          <br/>
        <canvas id="filter3-canvas" style="border: none;" width="512" height="512"></canvas>
      </div>
    </div>
  </div>
</body>

</html>