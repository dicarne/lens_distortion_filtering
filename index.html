<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>Radial lens undistortion filter</title>
  <script type="text/javascript" src="utils/glMatrix-0.9.5.min.js"></script>
  <script type="text/javascript" src="utils/webgl-utils.js"></script>
  <script type="text/javascript" src="utils/webgl-debug.js"></script>
  <link rel="stylesheet" type="text/css" href="css/modernpanel.css">

  <script id="shader-fs" type="x-shader/x-fragment">
    precision mediump float;
    
    uniform sampler2D texture_diffuse;
    uniform vec2 image_dimensions;
    uniform float alphax;
    uniform float alphay;
    uniform float k2x;
    uniform float k2y;
    
    varying vec4 pass_Color;
    varying vec2 pass_TextureCoord;

    void main(void) {
    
      // Normalize the u,v coordinates in the range [-1;+1]
      float x = (2.0 * pass_TextureCoord.x - 1.0) / 1.0;
      float y = (2.0 * pass_TextureCoord.y - 1.0) / 1.0;
      
      // Calculate l2 norm
      float r = x*x + y*y;
      
      // Calculate the deflated or inflated new coordinate (reverse transform)
      //float x3 = x / (1.0 - alphax * r);
		  //float y3 = y / (1.0 - alphay * r); 
			//float x2 = x / (1.0 - alphax * (x3 * x3 + y3 * y3));
			//float y2 = y / (1.0 - alphay * (x3 * x3 + y3 * y3));	
      
      float x2 = x / (1.0 - alphax * r - k2x * r * r);
      float y2 = y / (1.0 - alphay * r - k2y * r * r);

      // Forward transform
      // float x2 = x * (1.0 - alphax * r);
      // float y2 = y * (1.0 - alphay * r);

      // De-normalize to the original range
      float i2 = (x2 + 1.0) * 1.0 / 2.0;
      float j2 = (y2 + 1.0) * 1.0 / 2.0;
    
      if(i2 >= 0.0 && i2 <= 1.0 && j2 >= 0.0 && j2 <= 1.0)
        gl_FragColor = texture2D(texture_diffuse, vec2(i2, j2));
      else
        gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
    }
  </script>

  <script id="shader2-fs" type="x-shader/x-fragment">
    precision mediump float;
    
    uniform sampler2D texture_diffuse;
    uniform vec2 image_dimensions;
    uniform float alphax;
    uniform float alphay;
    uniform float k2x;
    uniform float k2y;
    
    varying vec4 pass_Color;
    varying vec2 pass_TextureCoord;

    void main(void) {
    
      // Normalize the u,v coordinates in the range [-1;+1]
      float x = (2.0 * pass_TextureCoord.x - 1.0) / 1.0;
      float y = (2.0 * pass_TextureCoord.y - 1.0) / 1.0;
      
      // Calculate l2 norm
      float r = x*x + y*y;
      
      // Calculate the deflated or inflated new coordinate (reverse transform)
      //float x3 = x / (1.0 - alphax * r);
		  //float y3 = y / (1.0 - alphay * r); 
			//float x2 = x / (1.0 - alphax * (x3 * x3 + y3 * y3));
			//float y2 = y / (1.0 - alphay * (x3 * x3 + y3 * y3));	
      
      float x2 = x / (1.0 - alphax * r - k2x * r * r);
      float y2 = y / (1.0 - alphay * r - k2y * r * r);

      // Forward transform
      // float x2 = x * (1.0 - alphax * r);
      // float y2 = y * (1.0 - alphay * r);

      // De-normalize to the original range
      float i2 = (x2 + 1.0) * 1.0 / 2.0;
      float j2 = (y2 + 1.0) * 1.0 / 2.0;
    
      if(i2 >= 0.0 && i2 <= 1.0 && j2 >= 0.0 && j2 <= 1.0)
        gl_FragColor = texture2D(texture_diffuse, vec2(i2, j2));
      else
        gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
    }
  </script>

  <script id="shader-vs" type="x-shader/x-vertex">
    attribute vec4 in_Position;
    attribute vec4 in_Color;
    attribute vec2 in_TextureCoord;    
    
    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
    
    varying vec4 pass_Color;
    varying vec2 pass_TextureCoord;
    
    void main(void) {
      gl_Position = uPMatrix * uMVMatrix * in_Position;
      
      pass_Color = in_Color;
      pass_TextureCoord = in_TextureCoord;
    }
  </script>
  <script type="text/javascript" src="distortion.js"></script>

</head>

<body onload="webGLStart();">
  <div class="header"></div>
  <div id="main_panel">
    <div class="container">
      <div id="slider_mainbox">
        <div class="row">
          <div class="col-xs-12 col-sm-6">
            <div class="slider_panel">
              <div class="canvastag">
                用于畸变的畸变参数
              </div>
              <div class="slider_box">
                <div class="k-tag">k1</div>
                <input id="k1_slider" type="range" style="vertical-align:middle;" min="-100" max="100" value="0" onchange="adjustAlphaFactor('k1', this.value)"
                  oninput="adjustAlphaFactor('k1', this.value)" />
                <input type="text" class="valueshowr" id="k1_value" style="vertical-align:middle; width: 50px; text-align: center;" value="0.0"
                  readonly>
              </div>
              <div class="slider_box">
                <div class="k-tag">k2</div>
                <input id="k2_slider" type="range" style="vertical-align:middle;" min="-100" max="100" value="0" onchange="adjustAlphaFactor('k2', this.value)"
                  oninput="adjustAlphaFactor('k2', this.value)" />
                <input type="text" class="valueshowr" id="k2_value" style="vertical-align:middle; width: 50px; text-align: center;" value="0.0"
                  readonly>
              </div>
            </div>
          </div>
          <div class="col-xs-12 col-sm-6">
            <div class="slider_panel">
              <div class="canvastag">
                用于反畸变的畸变参数
              </div>
              <div class="slider_box">
                <div class="k-tag">k1</div>
                <input id="k1a_slider2" type="range" style="vertical-align:middle;" min="-100" max="100" value="0" onchange="adjustAlphaFactor('k1a', this.value)"
                  oninput="adjustAlphaFactor('k1a', this.value)" />
                <input type="text" class="valueshowr" id="k1a_value2" style="vertical-align:middle; width: 50px; text-align: center;" value="0.0"
                  readonly>
              </div>
              <div class="slider_box">
                <div class="k-tag">k2</div>
                <input id="k2a_slider2" type="range" style="vertical-align:middle;" min="-100" max="100" value="0" onchange="adjustAlphaFactor('k2a', this.value)"
                  oninput="adjustAlphaFactor('k2a', this.value)" />
                <input type="text" class="valueshowr" id="k2a_value2" style="vertical-align:middle; width: 50px; text-align: center;" value="0.0"
                  readonly>
              </div>
            </div>

          </div>
        </div>
        <div>
          <button id="resetbutton" type="button" onclick="reset()">重置</button>
        </div>
      </div>
    </div>

    <!--        -->
    <div class="container">
      <div class="row">
        <div class="pull-left col-xs-12 col-sm-6">
          <div class="glcanvas">
            <div class="canvastag">原图经过透镜畸变后的图像</div>
            <canvas id="filter-canvas" style="border: none;" width="256" height="256"></canvas>
          </div>
        </div>
        <div class="pull-left col-xs-12 col-sm-6">
          <div class="glcanvas">
            <div class="canvastag">图像经过透镜畸变后复原的结果</div>
            <canvas id="filter2-canvas" style="border: none;" width="256" height="256"></canvas>
          </div>
        </div>


        <div class="pull-left col-xs-12 col-sm-6">
          <div class="glcanvas">
            <div class="canvastag">原图反畸变后</div>
            <canvas id="filter0-canvas" style="border: none;" width="256" height="256"></canvas>
          </div>
        </div>
        <div class="pull-left col-xs-12 col-sm-6">
          <div class="glcanvas">
            <div class="canvastag">原图</div>
            <canvas id="filter3-canvas" style="border: none;" width="256" height="256"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
    <a href="https://github.com/dicarne/lens_distortion_filtering">Sourse code in Github</a>
  </div>
</body>

</html>